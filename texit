# MacOS edition.

# Script to autocompile latex documents
# by detecting a change in filebasename status.

# Author: Oliver Chauncey Gorton

# Counting variables
stattime=0 
compiles=0

# Settings
bg=0 # If 1, run script in the background.
runtime=9999 # If >0, max time to run
slptime=1.0 # Time to wait between status checks

usage()
{
    echo "texit [basefilename] [options]"
}

#Get user filebasename from command line
filebasename=$1

#No filebasename found on command line, request from user.
if [ $# -eq 0 ]
then
        echo "Please provide an input .tex file (ommit .tex)":
        read filebasename
fi

# Check option flags
while [ "$1" != "" ]; do
    case $1 in
        -h | --help )           usage
                                exit
                                ;;
        -bg | --background )    bg=1
                                ;;
        -t | --timeout )        shift
                                runtime=$1
                                ;;
        * )                    
                                
    esac
    shift
done

# Check for existence of file
if [[ -f "$filebasename.tex" ]]
then
    filebasename=$filebasename'.tex'
    echo Texing: $filebasename
else
    echo "$filebasename.tex not found"
    return 1
fi

# Initialize
# If this command doesn't work something's not right.
if {
    fmt='-c %Z'    
    echo "Trying linux initialization."
    stattime=($(stat $fmt $filebasename)) #Linux
}; then { 
    echo "Initialize success."
}; else {
    echo "Initialize failed."
    echo "Trying macOS initialization."
    fmt='-f %c'
    
    if {
        stattime=($(stat $fmt $filebasename)) #macOS
    }; then {
        echo "Initialization success."
    }; else {
        echo "Initialization failed. Incompatible stat command!"
    }
    fi

}
fi

{ # Main task
while true; do

    stattimenew=($(stat $fmt $filebasename))

    # Detect change in source filebasename
    if [ $stattimenew -ne $stattime ]; then
        if { # try double compile
            pdflatex -halt-on-error ./$filebasename > texit.log;
            pdflatex -halt-on-error ./$filebasename > texit.out;
        }; then { # success
            ((compiles++))
            if [ $bg -eq 0 ]; then
                echo "Compile #$compiles success at "$(date)
            fi
            rm *.log *.aux
        }; else  { # catch
            echo "Compile failed."
        }
        fi
        sleep 2 # wait extra time after compile
    fi
    stattime=$stattimenew
    sleep $slptime
done
} & disown
TASK_PID=$! # Get main task ID
if [ $bg -eq 1 ] 
then
{
    echo "Running in background. See you in $runtime seconds!"
    sleep $runtime  
    echo "Texit done." 
    kill $TASK_PID 
} & disown
else
    sleep $runtime # Wait for max runtime
    echo "Texit done."
    kill $TASK_PID
fi
